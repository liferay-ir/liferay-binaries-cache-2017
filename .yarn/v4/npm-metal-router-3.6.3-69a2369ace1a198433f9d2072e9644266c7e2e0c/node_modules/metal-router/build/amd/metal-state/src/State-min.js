define(["exports","metal/src/metal","metal-events/src/events"],function(t,e,a){"use strict";function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}(),o=function u(t,e,a){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,e);if(void 0===i){var n=Object.getPrototypeOf(t);return null===n?void 0:u(n,e,a)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(a)},l=function(t){function a(t,s,r){i(this,a);var o=n(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));return o.context_=r||o,o.keysBlacklist_=null,o.obj_=s||o,o.eventData_=null,o.scheduledBatchData_=null,o.stateInfo_={},o.stateConfigs_={},o.initialValues_=e.object.mixin({},t),o.setShouldUseFacade(!0),o.configStateFromStaticHint_(),Object.defineProperty(o.obj_,a.STATE_REF_KEY,{configurable:!0,enumerable:!1,value:o}),o}return s(a,t),r(a,[{key:"assertGivenIfRequired_",value:function(t){var i=this.stateConfigs_[t];if(i.required){var n=this.getStateInfo(t),s=n.state===a.KeyStates.INITIALIZED?this.get(t):this.initialValues_[t];if(!(0,e.isDefAndNotNull)(s)){var r='The property called "'+t+"\" is required but didn't receive a value.";if(this.shouldThrowValidationError())throw new Error(r)}}}},{key:"assertValidatorReturnInstanceOfError_",value:function(t){if(t instanceof Error&&this.shouldThrowValidationError())throw t}},{key:"assertValidStateKeyName_",value:function(t){if(this.keysBlacklist_&&this.keysBlacklist_[t])throw new Error("It's not allowed to create a state key with the name \""+t+'".')}},{key:"buildKeyPropertyDef_",value:function(t){return{configurable:!0,enumerable:!0,get:function(){return this[a.STATE_REF_KEY].getStateKeyValue_(t)},set:function(e){this[a.STATE_REF_KEY].setStateKeyValue_(t,e)}}}},{key:"callFunction_",value:function(t,a){return(0,e.isString)(t)?this.context_[t].apply(this.context_,a):(0,e.isFunction)(t)?t.apply(this.context_,a):void 0}},{key:"callSetter_",value:function(t,e,a){var i=this.stateConfigs_[t];return i.setter&&(e=this.callFunction_(i.setter,[e,a])),e}},{key:"callValidator_",value:function(t,e){var a=this.stateConfigs_[t];if(a.validator){var i=this.callFunction_(a.validator,[e,t,this.context_]);return this.assertValidatorReturnInstanceOfError_(i),i}return!0}},{key:"canSetState",value:function(t){var e=this.getStateInfo(t);return!this.stateConfigs_[t].writeOnce||!e.written}},{key:"configState",value:function(t,e){var a=Object.keys(t);if(0!==a.length){if(e!==!1){for(var i={},n=0;n<a.length;n++){var s=a[n];this.assertValidStateKeyName_(s),i[s]=this.buildKeyPropertyDef_(s)}Object.defineProperties(e||this.obj_,i)}this.stateConfigs_=t;for(var r=0;r<a.length;r++){var o=a[r];t[o]=t[o].config?t[o].config:t[o],this.assertGivenIfRequired_(a[r]),this.validateInitialValue_(a[r])}}}},{key:"configStateFromStaticHint_",value:function(){var t=this.constructor;if(t!==a){var e=void 0;this.obj_===this&&(e=!t.hasConfiguredState_&&t.prototype,t.hasConfiguredState_=!0),this.configState(a.getStateStatic(t),e)}}},{key:"disposeInternal",value:function(){o(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"disposeInternal",this).call(this),this.initialValues_=null,this.stateInfo_=null,this.stateConfigs_=null,this.scheduledBatchData_=null}},{key:"emitBatchEvent_",value:function(){if(!this.isDisposed()){var t=this.scheduledBatchData_;this.scheduledBatchData_=null,this.context_.emit("stateChanged",t)}}},{key:"get",value:function(t){return this.obj_[t]}},{key:"getState",value:function(t){for(var e={},a=t||this.getStateKeys(),i=0;i<a.length;i++)e[a[i]]=this.get(a[i]);return e}},{key:"getStateInfo",value:function(t){return this.stateInfo_[t]||(this.stateInfo_[t]={}),this.stateInfo_[t]}},{key:"getStateKeyConfig",value:function(t){return this.stateConfigs_?this.stateConfigs_[t]:null}},{key:"getStateKeys",value:function(){return this.stateConfigs_?Object.keys(this.stateConfigs_):[]}},{key:"getStateKeyValue_",value:function(t){if(!this.warnIfDisposed_(t))return this.initStateKey_(t),this.getStateInfo(t).value}},{key:"hasBeenSet",value:function(t){var e=this.getStateInfo(t);return e.state===a.KeyStates.INITIALIZED||this.hasInitialValue_(t)}},{key:"hasInitialValue_",value:function(t){return this.initialValues_.hasOwnProperty(t)}},{key:"hasStateKey",value:function(t){if(!this.warnIfDisposed_(t))return!!this.stateConfigs_[t]}},{key:"informChange_",value:function(t,a){if(this.shouldInformChange_(t,a)){var i=e.object.mixin({key:t,newVal:this.get(t),prevVal:a},this.eventData_);this.context_.emit(t+"Changed",i),this.context_.emit("stateKeyChanged",i),this.scheduleBatchEvent_(i)}}},{key:"initStateKey_",value:function(t){var e=this.getStateInfo(t);e.state===a.KeyStates.UNINITIALIZED&&(e.state=a.KeyStates.INITIALIZING,this.setInitialValue_(t),e.written||this.setDefaultValue(t),e.state=a.KeyStates.INITIALIZED)}},{key:"removeStateKey",value:function(t){this.stateInfo_[t]=null,this.stateConfigs_[t]=null,delete this.obj_[t]}},{key:"scheduleBatchEvent_",value:function(t){this.scheduledBatchData_||(e.async.nextTick(this.emitBatchEvent_,this),this.scheduledBatchData_=e.object.mixin({changes:{}},this.eventData_));var a=t.key,i=this.scheduledBatchData_.changes;i[a]?i[a].newVal=t.newVal:i[a]=t}},{key:"set",value:function(t,e){this.hasStateKey(t)&&(this.obj_[t]=e)}},{key:"setDefaultValue",value:function(t){var e=this.stateConfigs_[t];void 0!==e.value?this.set(t,e.value):this.set(t,this.callFunction_(e.valueFn))}},{key:"setEventData",value:function(t){this.eventData_=t}},{key:"setInitialValue_",value:function(t){this.hasInitialValue_(t)&&(this.set(t,this.initialValues_[t]),this.initialValues_[t]=void 0)}},{key:"setKeysBlacklist",value:function(t){this.keysBlacklist_=t}},{key:"setState",value:function(t,e){var a=this;Object.keys(t).forEach(function(e){return a.set(e,t[e])}),e&&this.scheduledBatchData_&&this.context_.once("stateChanged",e)}},{key:"setStateKeyValue_",value:function(t,e){if(!this.warnIfDisposed_(t)&&this.canSetState(t)&&this.validateKeyValue_(t,e)){var a=this.get(t),i=this.getStateInfo(t);i.value=this.callSetter_(t,e,a),this.assertGivenIfRequired_(t),i.written=!0,this.informChange_(t,a)}}},{key:"shouldInformChange_",value:function(t,i){var n=this.getStateInfo(t);return n.state===a.KeyStates.INITIALIZED&&((0,e.isObject)(i)||i!==this.get(t))}},{key:"shouldThrowValidationError",value:function(){return!1}},{key:"validateInitialValue_",value:function(t){this.hasInitialValue_(t)&&!this.callValidator_(t,this.initialValues_[t])&&delete this.initialValues_[t]}},{key:"validateKeyValue_",value:function(t,e){var i=this.getStateInfo(t);return i.state===a.KeyStates.INITIALIZING||this.callValidator_(t,e)}},{key:"warnIfDisposed_",value:function(t){var e=this.isDisposed();return e}}],[{key:"getStateStatic",value:function(t){return(0,e.getStaticProperty)(t,"STATE",a.mergeState)}},{key:"mergeState",value:function(t,a){return e.object.mixin({},a,t)}}]),a}(a.EventEmitter);l.STATE_REF_KEY="__METAL_STATE_REF_KEY__",l.KeyStates={UNINITIALIZED:void 0,INITIALIZING:1,INITIALIZED:2},t["default"]=l});