define(["exports","metal/src/metal","metal-dom/src/all/dom","metal-promise/src/promise/Promise","../globals/globals","./RequestScreen","../surface/Surface","metal-useragent/src/UA","metal-uri/src/Uri","../utils/utils"],function(e,t,r,n,o,a,l,u,i,c){"use strict";function s(e){return e&&e.__esModule?e:{"default":e}}function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function y(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var d=s(n),m=s(o),v=s(a),h=s(l),_=s(u),S=s(i),b=s(c),k=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),g=function O(e,t,r){null===e&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,t);if(void 0===n){var o=Object.getPrototypeOf(e);return null===o?void 0:O(o,t,r)}if("value"in n)return n.value;var a=n.get;if(void 0!==a)return a.call(r)},D=function(e){function n(){p(this,n);var e=y(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.titleSelector="title",e}return f(n,e),k(n,[{key:"activate",value:function(){g(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"activate",this).call(this),this.releaseVirtualDocument(),this.pendingStyles=null}},{key:"allocateVirtualDocumentForContent",value:function(e){this.virtualDocument||(this.virtualDocument=m["default"].document.createElement("html")),this.copyNodeAttributesFromContent_(e,this.virtualDocument),this.virtualDocument.innerHTML=e}},{key:"appendStyleIntoDocument_",value:function(e){var t=(0,r.match)(e,n.selectors.stylesTemporary);if(t&&this.pendingStyles.push(e),e.id){var o=m["default"].document.getElementById(e.id);if(o)return void o.parentNode.insertBefore(e,o.nextSibling)}m["default"].document.head.appendChild(e)}},{key:"assertSameBodyIdInVirtualDocument",value:function(){var e=this.virtualDocument.querySelector("body");m["default"].document.body.id||(m["default"].document.body.id="senna_surface_"+(0,t.getUid)()),e&&(e.id=m["default"].document.body.id)}},{key:"copyNodeAttributesFromContent_",value:function(e,t){e=e.replace(/[<]\s*html/gi,"<senna"),e=e.replace(/\/html\s*\>/gi,"/senna>"),t.innerHTML=e;var r=t.querySelector("senna");r&&(b["default"].clearNodeAttributes(t),b["default"].copyNodeAttributes(r,t))}},{key:"disposeInternal",value:function(){this.disposePendingStyles(),g(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"disposeInternal",this).call(this)}},{key:"disposePendingStyles",value:function(){this.pendingStyles&&this.pendingStyles.forEach(function(e){return(0,r.exitDocument)(e)})}},{key:"evaluateScripts",value:function(e){var t=this,o=this.evaluateTrackedResources_(r.globalEval.runScriptsInElement,n.selectors.scripts,n.selectors.scriptsTemporary,n.selectors.scriptsPermanent);return o.then(function(){return g(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"evaluateScripts",t).call(t,e)})}},{key:"evaluateStyles",value:function(e){var t=this;this.pendingStyles=[];var o=this.evaluateTrackedResources_(r.globalEvalStyles.runStylesInElement,n.selectors.styles,n.selectors.stylesTemporary,n.selectors.stylesPermanent,this.appendStyleIntoDocument_.bind(this));return o.then(function(){return g(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"evaluateStyles",t).call(t,e)})}},{key:"evaluateTrackedResources_",value:function(e,t,o,a,l){var u=this,i=this.virtualQuerySelectorAll_(t),c=this.querySelectorAll_(o),s=this.querySelectorAll_(a);s.forEach(function(e){var t=u.getResourceKey_(e);t&&(n.permanentResourcesInDoc[t]=!0)});var p=(0,r.buildFragment)();return i.forEach(function(e){var t=u.getResourceKey_(e);n.permanentResourcesInDoc[t]||p.appendChild(e),t&&(0,r.match)(e,a)&&(n.permanentResourcesInDoc[t]=!0)}),new d["default"](function(t){e(p,function(){c.forEach(function(e){return(0,r.exitDocument)(e)}),t()},l)})}},{key:"flip",value:function(e){var t=this;return g(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"flip",this).call(this,e).then(function(){b["default"].clearNodeAttributes(document.documentElement),b["default"].copyNodeAttributes(t.virtualDocument,document.documentElement)})}},{key:"getResourceKey_",value:function(e){return e.id||e.href||e.src||""}},{key:"getSurfaceContent",value:function(e){var t=this.virtualDocument.querySelector("#"+e);if(t){var r=t.querySelector("#"+e+"-"+h["default"].DEFAULT);return r?r.innerHTML:t.innerHTML}}},{key:"getTitleSelector",value:function(){return this.titleSelector}},{key:"load",value:function(e){var t=this;return g(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"load",this).call(this,e).then(function(e){return t.allocateVirtualDocumentForContent(e),t.resolveTitleFromVirtualDocument(),t.assertSameBodyIdInVirtualDocument(),_["default"].isIe&&t.makeTemporaryStylesHrefsUnique_(),e})}},{key:"makeTemporaryStylesHrefsUnique_",value:function(){var e=this,t=this.virtualQuerySelectorAll_(n.selectors.stylesTemporary);t.forEach(function(t){return e.replaceStyleAndMakeUnique_(t)})}},{key:"replaceStyleAndMakeUnique_",value:function(e){if(e.href){var t=m["default"].document.createElement(e.tagName);e.href=new S["default"](e.href).makeUnique().toString(),b["default"].copyNodeAttributes(e,t),e.parentNode.replaceChild(t,e),e.disabled=!0}}},{key:"virtualQuerySelectorAll_",value:function(e){return Array.prototype.slice.call(this.virtualDocument.querySelectorAll(e))}},{key:"querySelectorAll_",value:function(e){return Array.prototype.slice.call(m["default"].document.querySelectorAll(e))}},{key:"releaseVirtualDocument",value:function(){this.virtualDocument=null}},{key:"resolveTitleFromVirtualDocument",value:function(){var e=this.virtualDocument.querySelector(this.titleSelector);e&&this.setTitle(e.textContent.trim())}},{key:"setTitleSelector",value:function(e){this.titleSelector=e}}]),n}(v["default"]);D.selectors={scripts:"script[data-senna-track]",scriptsPermanent:'script[data-senna-track="permanent"]',scriptsTemporary:'script[data-senna-track="temporary"]',styles:"style[data-senna-track],link[data-senna-track]",stylesPermanent:'style[data-senna-track="permanent"],link[data-senna-track="permanent"]',stylesTemporary:'style[data-senna-track="temporary"],link[data-senna-track="temporary"]'},D.permanentResourcesInDoc={},e["default"]=D});