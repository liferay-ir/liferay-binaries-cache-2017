define(["exports","metal/src/metal","metal-ajax/src/Ajax","metal-structs/src/all/structs","metal-promise/src/promise/Promise","../errors/errors","../utils/utils","../globals/globals","./Screen","metal-uri/src/Uri","metal-useragent/src/UA"],function(e,t,r,a,n,u,o,s,i,l,c){"use strict";function f(e){return e&&e.__esModule?e:{"default":e}}function d(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var m=f(r),y=f(n),E=f(u),v=f(o),R=f(s),b=f(i),T=f(l),g=f(c),w=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),_=function(e){function r(){d(this,r);var e=h(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return e.cacheable=!0,e.httpHeaders={"X-PJAX":"true","X-Requested-With":"XMLHttpRequest"},e.httpMethod=r.GET,e.request=null,e.timeout=3e4,e}return p(r,e),w(r,[{key:"assertValidResponseStatusCode",value:function(e){if(!this.isValidResponseStatusCode(e)){var t=new Error(E["default"].INVALID_STATUS);throw t.invalidStatus=!0,t.statusCode=e,t}}},{key:"beforeUpdateHistoryPath",value:function(e){var t=this.getRequestPath();return t&&t!==e?t:e}},{key:"beforeUpdateHistoryState",value:function(e){return e.senna&&e.form&&e.redirectPath===e.path?null:e}},{key:"formatLoadPath",value:function(e){var t=new T["default"](e);return t.setHostname(R["default"].window.location.hostname),t.setProtocol(R["default"].window.location.protocol),R["default"].window.location.port&&t.setPort(R["default"].window.location.port),g["default"].isIeOrEdge&&this.httpMethod===r.GET?t.makeUnique().toString():t.toString()}},{key:"getHttpHeaders",value:function(){return this.httpHeaders}},{key:"getHttpMethod",value:function(){return this.httpMethod}},{key:"getRequestPath",value:function(){var e=this.getRequest();if(e){var t=e.requestPath,a=this.maybeExtractResponseUrlFromRequest(e);return a&&(t=a),g["default"].isIeOrEdge&&this.httpMethod===r.GET&&(t=new T["default"](t).removeUnique().toString()),v["default"].getUrlPath(t)}return null}},{key:"getRequest",value:function(){return this.request}},{key:"getTimeout",value:function(){return this.timeout}},{key:"isValidResponseStatusCode",value:function(e){return e>=200&&e<=399}},{key:"load",value:function(e){var n=this,u=this.getCache();if((0,t.isDefAndNotNull)(u))return y["default"].resolve(u);var o=null,s=this.httpMethod,i=new a.MultiMap;Object.keys(this.httpHeaders).forEach(function(e){return i.add(e,n.httpHeaders[e])}),R["default"].capturedFormElement&&(o=new FormData(R["default"].capturedFormElement),this.maybeAppendSubmitButtonValue_(o),s=r.POST,g["default"].isIeOrEdge&&i.add("If-None-Match",'"0"'));var l=this.formatLoadPath(e);return m["default"].request(l,s,o,i,null,this.timeout).then(function(e){return n.setRequest(e),n.assertValidResponseStatusCode(e.status),s===r.GET&&n.isCacheable()&&n.addCache(e.responseText),e.requestPath=l,e.responseText})["catch"](function(e){switch(e.message){case E["default"].REQUEST_TIMEOUT:e.timeout=!0;break;case E["default"].REQUEST_ERROR:e.requestError=!0;break;case E["default"].REQUEST_PREMATURE_TERMINATION:e.requestError=!0,e.requestPrematureTermination=!0}throw e})}},{key:"maybeAppendSubmitButtonValue_",value:function(e){var t=R["default"].capturedFormButtonElement;t&&t.name&&e.append(t.name,t.value)}},{key:"maybeExtractResponseUrlFromRequest",value:function(e){var t=e.responseURL;return t?t:e.getResponseHeader(r.X_REQUEST_URL_HEADER)}},{key:"setHttpHeaders",value:function(e){this.httpHeaders=e}},{key:"setHttpMethod",value:function(e){this.httpMethod=e.toLowerCase()}},{key:"setRequest",value:function(e){this.request=e}},{key:"setTimeout",value:function(e){this.timeout=e}}]),r}(b["default"]);_.GET="get",_.POST="post",_.X_REQUEST_URL_HEADER="X-Request-URL",e["default"]=_});