define(["exports","metal/src/metal","senna/src/senna","metal-promise/src/promise/Promise","metal-component/src/all/component","metal-incremental-dom/src/IncrementalDomRenderer","metal-uri/src/Uri"],function(e,t,r,n,o,a,u){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function c(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var h=i(n),v=i(a),d=i(u),p=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),y=function b(e,t,r){null===e&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,t);if(void 0===n){var o=Object.getPrototypeOf(e);return null===o?void 0:b(o,t,r)}if("value"in n)return n.value;var a=n.get;if(void 0!==a)return a.call(r)},m=function(e){function n(){return s(this,n),l(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return f(n,e),p(n,[{key:"created",value:function(){this.route=new r.Route(this.path,this.createScreen_.bind(this)),this.route.router=this,n.router().addRoutes(this.route),this.firstRenderElement=this.element,this.element=null}},{key:"addRoutingData",value:function(e,r){if(this.includeRoutingData){var n=this.lastExtractedParams||this.extractParams(e),o=this.extractQuery(e);return t.object.mixin({},r,{router:{currentUrl:e,params:n,query:o}})}return r}},{key:"attached",value:function(){this.wasRendered||(this.element=this.firstRenderElement)}},{key:"createScreen_",value:function(){return this.screen_=new n.defaultScreen(this),this.screen_}},{key:"disposeInternal",value:function(){n.activeRouter===this&&(n.activeRouter=null),n.router().removeRoute(this.route),y(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"disposeInternal",this).call(this)}},{key:"extractParams",value:function(e){return n.router().extractParams(this.route,e)}},{key:"extractQuery",value:function(e){for(var t=new d["default"](e),r={},n=t.getParameterNames(),o=0;o<n.length;o++){var a=n[o];r[a]=t.getParameterValue(a)}return r}},{key:"getRouteComponent",value:function(){return this.components.comp}},{key:"getScreen",value:function(){return this.screen_}},{key:"render",value:function(){if(this.isActive_){var e;(e=IncrementalDOM).elementVoid.apply(e,[this.component,null,null,"ref","comp"].concat(c(this.toArray_(n.activeState))))}}},{key:"setterComponentFn_",value:function(e){return t.core.isString(e)&&(e=o.ComponentRegistry.getConstructor(e)),e}},{key:"shouldUpdate",value:function(e){return e.isActive_||e.component}},{key:"toArray_",value:function(e){for(var t=[],r=Object.keys(e||{}),n=0;n<r.length;n++)t.push(r[n],e[r[n]]);return t}}],[{key:"getActiveComponent",value:function(){return n.activeRouter?n.activeRouter.getRouteComponent():null}},{key:"getActiveState",value:function(){return n.activeState}},{key:"router",value:function(){if(!n.routerInstance){var e=new r.App;e.setIgnoreQueryStringFromRoutePath(!0),n.routerInstance=e}return n.routerInstance}}]),n}(o.Component);m.RENDERER=v["default"],m.STATE={beforeDeactivateHandler:{validator:function(e){return t.core.isString(e)||t.core.isFunction(e)}},cacheable:{validator:t.core.isBoolean,value:!0},component:{setter:"setterComponentFn_"},data:{setter:function(e){return t.core.isFunction(e)?e:function(){return e||{}}}},fetch:{value:!1},fetchUrl:{validator:function(e){return t.core.isString(e)||t.core.isFunction(e)}},fetchTimeout:{validator:function(e){return t.core.isNumber(e)||!t.core.isDefAndNotNull(e)},value:3e4},includeRoutingData:{value:!0},isActive_:{internal:!0,value:!1},path:{}},m.activeRouter=null,m.activeState=null;var R=function(e){function r(e){s(this,r);var t=l(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));if(!e)throw new Error("Router not specified for component screen.");return t.router=e,t.timeout=e.fetchTimeout,t}return f(r,e),p(r,[{key:"beforeDeactivate",value:function(){var e=this.router.beforeDeactivateHandler;if(e){if(t.core.isString(e)){var r=this.router.getRouteComponent();if(r&&t.core.isFunction(r[e]))return r[e]();var n=(0,t.getFunctionName)(r);throw new Error('No function named "'+e+'" exists inside '+n+".")}return e()}}},{key:"beforeUpdateHistoryPath",value:function(e){return this.router.fetchUrl?e:y(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"beforeUpdateHistoryPath",this).call(this,e)}},{key:"evaluateScripts",value:function(){}},{key:"evaluateStyles",value:function(){}},{key:"flip",value:function(){this.maybeRedirectRouter(),m.activeState=this.router.addRoutingData(this.router.lastPath,this.maybeParseLastLoadedStateAsJson()),m.activeRouter&&(m.activeRouter.isActive_=!1,this.reuseActiveRouterElementInNewRouter_(this.router));var e=this.waitRouterRenderSubComponents(this.router);return m.activeRouter=this.router,m.activeRouter.isActive_=!0,e}},{key:"getFetchUrl_",value:function(e){var r=this.router.fetchUrl||e;return t.core.isFunction(r)&&(r=r(e)),r}},{key:"load",value:function(e){var t=this;this.setCacheable(this.router.cacheable);var n=h["default"].resolve(),o=void 0;return this.router.fetch?n=n.then(function(){return y(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"load",t).call(t,t.getFetchUrl_(e))}):(o=this.router.extractParams(e),n=n.then(function(){return t.router.data(e,o)})),n.then(function(r){return t.router.lastPath=e,t.router.lastRedirectPath=t.maybeFindRedirectPath(),t.router.lastLoadedState=r,t.router.lastExtractedParams=o,r})}},{key:"maybeFindRedirectPath",value:function(){var e=this.beforeUpdateHistoryPath(this.router.lastPath);return e!==this.router.lastPath?e:null}},{key:"maybeFindRedirectRouter",value:function(){var e=this.maybeFindRedirectPath();if(e){var t=m.router().findRoute(e);if(t)return t.router.lastPath=this.router.lastRedirectPath,t.router.lastLoadedState=this.router.lastLoadedState,t.router}return null}},{key:"maybeParseLastLoadedStateAsJson",value:function(){var e=this.router.lastLoadedState;try{return JSON.parse(e)}catch(r){return t.core.isDefAndNotNull(e)?e:{}}}},{key:"maybeRedirectRouter",value:function(){var e=this.maybeFindRedirectRouter();if(e){this.router=e;var t=m.router();t.once("endNavigate",function(){t.screens[t.redirectPath]=t.screens[t.activePath],delete t.screens[t.activePath]})}}},{key:"reuseActiveRouterElementInNewRouter_",value:function(e){var t=m.activeRouter;t!==e&&t.firstRenderElement===e.firstRenderElement&&(e.element=t.element,t.element=null)}},{key:"waitRouterRenderSubComponents",value:function(e){return new Promise(function(t){return e.once("rendered",t)})}}]),r}(r.RequestScreen);m.defaultScreen=R,e["default"]=m});