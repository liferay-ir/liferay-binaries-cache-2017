define(["exports","./attributes","../callArgs","../children/children","../changes","metal-dom/src/all/dom","../data","metal/src/metal","../cleanup/unused","../incremental-dom-aop","metal-component/src/all/component"],function(e,n,t,r,o,a,i,c,l,u,s){"use strict";function p(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function f(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function d(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}function m(e,n){n["class"]?(n["class"]+=" "+e,n["class"]=M(n["class"])):n["class"]=e}function g(e){return 0===e.length?Q:e}function C(e){(0,u.stopInterception)(),(0,i.getData)(e).rootElementReached||(e.element=null),e.informRendered(),h()}function h(){J.pop(),0===J.length&&(0,l.disposeUnused)()}function v(e,n){var t=(0,i.getData)(e);return!t.rootElementReached&&t.config.key&&(n=t.config.key),e.getRenderer().generateKey(e,n)}function y(e){return e.childComponents=e.childComponents||[],e.childComponents}function D(){return J[J.length-1]}function R(){var e=IncrementalDOM.currentElement(),n=D(),t=(0,i.getData)(n);return t.rootElementReached&&e!==n.element.parentNode&&(t=a.domData.get(e)),t.icComponentsData=t.icComponentsData||{},t.icComponentsData}function b(e,n){var t=(0,c.getCompatibilityModeData)();if(t){var r=e.getRenderer(),o=t.renderers,a=!o||o.indexOf(r)!==-1||o.indexOf(r.RENDERER_NAME)!==-1;if(a&&n.key&&!n.ref)return n.key}return n.ref}function E(e,n,t){var r=e;(0,c.isString)(r)&&(r=s.ComponentRegistry.getConstructor(e));var o=b(t,n),a=void 0;if((0,c.isDef)(o))a=A(t.components[o],r,n,t),t.components[o]=a,t.refs[o]=a;else{var i=R(),l=n.key;if(!(0,c.isDef)(l)){var u=(0,c.getUid)(r,!0);i.currCount=i.currCount||{},i.currCount[u]=i.currCount[u]||0,l="__METAL_IC__"+u+"_"+i.currCount[u]++}a=A(i.prevComps?i.prevComps[l]:null,r,n,t),i.currComps=i.currComps||{},i.currComps[l]=a}return a}function _(e,n){var t=n.props,r=n.tag;return t.children=g(e.props.children),U(r,t)}function O(e){if(e.tag&&I(e.tag))return e.props.children=g(e.props.children),U(e.tag,e.props,(0,r.getOwner)(e)),!0}function k(e,t,r){(0,n.applyAttribute)(D(),e,t,r)}function w(e){return I(e)?j.apply(null,arguments):x.apply(null,arguments)}function x(){for(var e=arguments.length,o=Array(e),a=0;a<e;a++)o[a]=arguments[a];var l=(0,t.buildConfigFromCall)(o),s=o[0],p=D(),f=p;if((0,r.isChildTag)(s)&&(f=s.owner,s=s.tag),l.key=v(p,l.key),!(0,i.getData)(p).rootElementReached){var d=p.getDataManager().get(p,"elementClasses");d&&m(d,l)}(0,n.convertListenerNamesToFns)(p,l);var g=(0,t.buildCallFromConfig)(s,l),C=(0,u.getOriginalFn)("elementOpen").apply(null,g);return q(C),G(p,C),(0,c.isDefAndNotNull)(l.ref)&&(f.refs[l.ref]=C),f.getRenderer().handleNodeRendered(C),C}function j(){for(var e=arguments.length,n=Array(e),o=0;o<e;o++)n[o]=arguments[o];(0,r.captureChildren)(D(),_,{props:(0,t.buildConfigFromCall)(n),tag:n[0]})}function N(e,n){var t=(0,i.getData)(e),r=t.config;if(!t.rootElementReached&&r&&(0,c.isString)(r.elementClasses)){var o="";(0,c.isString)(n.elementClasses)&&(o=n.elementClasses+" "),n.elementClasses=o+r.elementClasses}}function I(e){return(0,c.isFunction)(e)||(0,c.isString)(e)&&e[0]===e[0].toUpperCase()}function S(e,n,t){return!(!e||e.constructor!==n||e.isDisposed())&&(0,i.getData)(e).owner===t}function A(e,n,t,r){return S(e,n,r)?(e.startSkipUpdates(),e.getDataManager().replaceNonInternal(e,t),e.stopSkipUpdates()):e=new n(t,(!1)),(0,i.getData)(e).config=t,e}function F(e){J.push(e);var n=(0,i.getData)(e);K(n.icComponentsData),(0,o.clearChanges)(n),n.rootElementReached=!1,e.refs={},n.childComponents&&((0,l.schedule)(n.childComponents),n.childComponents=null),(0,u.startInterception)({attributes:k,elementOpen:w})}function M(e){for(var n=[],t=e.split(/\s+/),r={},o=0;o<t.length;o++)r[t[o]]||(r[t[o]]=!0,n.push(t[o]));return n.join(" ")}function T(e){F(e),e.getRenderer().renderIncDom(e),C(e)}function P(e){(0,r.renderChildTree)(e,O)}function U(e,n,t){if((0,c.isString)(e)||e.prototype.getRenderer){var r=B(e,n,t);return G(D(),r.element),r.element}return e(n)}function L(e,n,t,r){if(!s.Component.isComponentCtor(n)){var o=n,a=function(e){function n(){return p(this,n),f(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return d(n,e),H(n,[{key:"created",value:function(){var e=D();e&&z(this,e)}},{key:"render",value:function(){o(this.getInitialConfig())}}]),n}(s.Component);a.RENDERER=e,n=a}return s.Component.render(n,t,r)}function B(e,n,t){var r=D(),o=t||r;N(r,n);var a=E(e,n,o);z(a,r);var c=(0,i.getData)(a);c.parent=r,c.owner=o;var l=(0,i.getData)(r);return y(l).push(a),n.key||l.rootElementReached||(n.key=l.config.key),a.getRenderer().renderInsidePatch(a),a.wasRendered||a.renderComponent(),a}function K(e){e&&(e.prevComps=e.currComps,e.currComps=null,e.currCount=null)}function q(e){a.domData.has(e)&&K(a.domData.get(e).icComponentsData)}function z(e,n){var t=e.context,r=n.getChildContext?n.getChildContext():null;c.object.mixin(t,n.context,r),e.context=t}function G(e,n){var t=(0,i.getData)(e);t.rootElementReached||(t.rootElementReached=!0,e.element!==n&&(e.element=n))}Object.defineProperty(e,"__esModule",{value:!0}),e.getComponentBeingRendered=D,e.isComponentTag_=I,e.render=T,e.renderChild=P,e.renderFunction=L;var H=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),J=[],Q=[]});