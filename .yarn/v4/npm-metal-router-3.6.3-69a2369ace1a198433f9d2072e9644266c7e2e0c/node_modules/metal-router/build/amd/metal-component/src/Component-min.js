define(["exports","./events/events","metal/src/metal","./sync/sync","metal-dom/src/all/dom","./ComponentDataManager","./ComponentRenderer","metal-events/src/events"],function(e,t,n,a,r,i,s,o){"use strict";function l(e){return e&&e.__esModule?e:{"default":e}}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function d(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function h(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(e,"__esModule",{value:!0});var p=l(i),y=l(s),v=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),f=function g(e,t,n){null===e&&(e=Function.prototype);var a=Object.getOwnPropertyDescriptor(e,t);if(void 0===a){var r=Object.getPrototypeOf(e);return null===r?void 0:g(r,t,n)}if("value"in a)return a.value;var i=a.get;if(void 0!==i)return i.call(n)},m=function(e){function i(e,t){h(this,i);var n=c(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return n.elementEventProxy_=new r.DomEventEmitterProxy(null,n,E),n.eventsStateKeyHandler_=null,n.inDocument=!1,n.initialConfig_=e||{},n.wasRendered=!1,n.DEFAULT_ELEMENT_PARENT=document.body,n.setShouldUseFacade(!0),n.element=n.initialConfig_.element,n.setUpRenderer_(),n.setUpDataManager_(),n.setUpSyncUpdates_(),n.on("stateChanged",n.handleComponentStateChanged_),n.on("eventsChanged",n.onEventsChanged_),n.addListenersFromObj_(n.dataManager_.get(n,"events")),n.created(),n.componentCreated_=!0,t!==!1&&n.renderComponent(t),n}return _(i,e),v(i,[{key:"addListenersFromObj_",value:function(e){var n;this.eventsStateKeyHandler_||(this.eventsStateKeyHandler_=new o.EventHandler);var a=(0,t.addListenersFromObj)(this,e);(n=this.eventsStateKeyHandler_).add.apply(n,d(a))}},{key:"attach",value:function(e,t){return this.inDocument||(this.attachElement(e,t),this.inDocument=!0,this.attachData_={parent:e,sibling:t},this.emit("attached",this.attachData_),this.attached()),this}},{key:"attached",value:function(){}},{key:"attachElement",value:function(e,t){var n=this.element;if(n&&(t||!n.parentNode)){var a=(0,r.toElement)(e)||this.DEFAULT_ELEMENT_PARENT;a.insertBefore(n,(0,r.toElement)(t))}}},{key:"created",value:function(){}},{key:"delegate",value:function(e,t,n){return this.on("delegate:"+e+":"+t,n)}},{key:"detach",value:function(){return this.inDocument&&(this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.inDocument=!1,this.detached()),this.emit("detached"),this}},{key:"detached",value:function(){}},{key:"disposed",value:function(){}},{key:"disposeInternal",value:function(){this.detach(),this.disposed(),this.elementEventProxy_.dispose(),this.elementEventProxy_=null,this.dataManager_.dispose(this),this.dataManager_=null,this.renderer_.dispose(this),this.renderer_=null,f(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"disposeInternal",this).call(this)}},{key:"getAttachData",value:function(){return this.attachData_}},{key:"getDataManager",value:function(){return this.dataManager_}},{key:"getInitialConfig",value:function(){return this.initialConfig_}},{key:"getState",value:function(){return this.dataManager_.getState(this)}},{key:"getStateKeys",value:function(){return this.dataManager_.getStateKeys(this)}},{key:"getRenderer",value:function(){return this.renderer_}},{key:"handleComponentElementChanged_",value:function(e,t){this.elementEventProxy_.setOriginEmitter(t),this.componentCreated_&&(this.emit("elementChanged",{prevVal:e,newVal:t}),t&&this.wasRendered&&this.syncVisible(this.dataManager_.get(this,"visible")))}},{key:"handleComponentStateChanged_",value:function(e){this.hasSyncUpdates()||this.updateRenderer_(e),(0,a.syncState)(this,e.changes),this.emit("stateSynced",e)}},{key:"handleComponentStateKeyChanged_",value:function(e){this.updateRenderer_({changes:u({},e.key,e)})}},{key:"hasSyncUpdates",value:function(){return this.syncUpdates_}},{key:"informRendered",value:function(){var e=!this.hasRendererRendered_;this.hasRendererRendered_=!0,this.rendered(e),this.emit("rendered",e)}},{key:"mergeElementClasses_",value:function(e,t){return e?e+" "+(t||""):t}},{key:"onEventsChanged_",value:function(e){this.eventsStateKeyHandler_.removeAllListeners(),this.addListenersFromObj_(e.newVal)}},{key:"renderComponent",value:function(e){this.hasRendererRendered_||(window.__METAL_DEV_TOOLS_HOOK__&&window.__METAL_DEV_TOOLS_HOOK__(this),this.getRenderer().render(this)),this.emit("render"),(0,a.syncState)(this),this.attach(e),this.wasRendered=!0}},{key:"setState",value:function(e,t){this.dataManager_.setState(this,e,t)}},{key:"setterElementClassesFn_",value:function(e){var t=(0,n.getStaticProperty)(this.constructor,"ELEMENT_CLASSES",this.mergeElementClasses_);return t&&(e+=" "+t),e.trim()}},{key:"setUpDataManager_",value:function(){this.dataManager_=(0,n.getStaticProperty)(this.constructor,"DATA_MANAGER"),this.dataManager_.setUp(this,n.object.mixin({},this.renderer_.getExtraDataConfig(this),i.DATA))}},{key:"setUpRenderer_",value:function(){this.renderer_=(0,n.getStaticProperty)(this.constructor,"RENDERER"),this.renderer_.setUp(this)}},{key:"setUpSyncUpdates_",value:function(){this.syncUpdates_=(0,n.getStaticProperty)(this.constructor,"SYNC_UPDATES"),this.hasSyncUpdates()&&this.on("stateKeyChanged",this.handleComponentStateKeyChanged_.bind(this))}},{key:"startSkipUpdates",value:function(){this.skipUpdates_=!0}},{key:"stopSkipUpdates",value:function(){this.skipUpdates_=!1}},{key:"syncVisible",value:function(e){this.element&&(this.element.style.display=e?"":"none")}},{key:"rendered",value:function(){}},{key:"updateRenderer_",value:function(e){!this.skipUpdates_&&this.hasRendererRendered_&&this.getRenderer().update(this,e)}},{key:"validatorEventsFn_",value:function(e){return!(0,n.isDefAndNotNull)(e)||(0,n.isObject)(e)}},{key:"element",get:function(){return this.elementValue_},set:function(e){if(((0,n.isElement)(e)||(0,n.isString)(e)||!(0,n.isDefAndNotNull)(e))&&(e&&(e=(0,r.toElement)(e)||this.elementValue_),this.elementValue_!==e)){var t=this.elementValue_;this.elementValue_=e,this.handleComponentElementChanged_(t,e)}}}],[{key:"isComponentCtor",value:function(e){return e.prototype&&e.prototype[i.COMPONENT_FLAG]}},{key:"render",value:function(e,t,a){var r=t,i=a;(0,n.isElement)(t)&&(r=null,i=t);var s=new e(r,(!1));return s.renderComponent(i),s}},{key:"renderToString",value:function(e,t){var n=e.RENDERER&&e.RENDERER.RENDERER_NAME;switch(n){case"jsx":case"soy":case"incremental-dom":if("undefined"==typeof IncrementalDOM)throw new Error("Error. Trying to render incremental dom based component to string requires IncrementalDOM implementation to be loaded.");var a=[],r=IncrementalDOM.patch,s=function(){var e=r.apply(null,arguments);a.push(e.innerHTML),IncrementalDOM.patch=r};return IncrementalDOM.patch=s,i.render(e,t).dispose(),a[0];default:throw new Error("Error. Trying to render non incremental dom based component to string.")}}}]),i}(o.EventEmitter);m.DATA={children:{validator:Array.isArray,value:[]},elementClasses:{setter:"setterElementClassesFn_",validator:n.isString,value:""},events:{validator:"validatorEventsFn_",value:null},visible:{validator:n.isBoolean,value:!0}},m.COMPONENT_FLAG="__metal_component__",m.DATA_MANAGER=p["default"],m.ELEMENT_CLASSES="",m.RENDERER=y["default"],m.SYNC_UPDATES=!1,m.prototype[m.COMPONENT_FLAG]=!0;var E={eventsChanged:!0,stateChanged:!0,stateKeyChanged:!0};e["default"]=m});